<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Deploying the MBrace Runtime
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="An open source framework for large-scale distributed computation and data processing written in F#."/>
    <meta name="author" content="Jan Dzik, Nick Palladinos, Kostas Rontogiannis, Eirik Tsarpalis"/>
    
    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-196x196.png" sizes="196x196"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-160x160.png" sizes="160x160"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-96x96.png" sizes="96x96"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-16x16.png" sizes="16x16"/>
    <link rel="icon" type="image/png" href="http://www.m-brace.net/img/favicon-32x32.png" sizes="32x32"/>

    <link type="text/css" rel="stylesheet" href="http://www.m-brace.net/content/style.css" />
    <script type="text/javascript" src="http://www.m-brace.net/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://nessos.github.io">nessos</a></li>
          <li><a href="http://github.com/mbraceproject/MBrace.Core">github page</a></li>
        </ul>
        <h3 class="muted"><a href="http://www.m-brace.net/index.html">MBrace</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Deploying-the-MBrace-Runtime" class="anchor" href="#Deploying-the-MBrace-Runtime">Deploying the MBrace Runtime</a></h1>

<p>In this tutorial you will learn how to install and setup MBrace.</p>

<p>Typically you need some machines to run the MBrace daemons/nodes and a client
that manages the runtime (usually the client runs on a F# interactive instance). Any nodes in a MBrace runtime,
as well as any clients, should be part of the same network in order to work properly.</p>

<h2><a name="a-name-installservice-a-Installing-the-MBrace-Runtime-Service" class="anchor" href="#a-name-installservice-a-Installing-the-MBrace-Runtime-Service"><a name="installservice"></a>Installing the MBrace Runtime Service</a></h2>

<p>In order to get a MBrace node running on a machine you need to download 
the <a href="http://nuget.org/packages/MBrace.Runtime">MBrace.Runtime</a> package.
Any dependencies and executables are located in the <code>tools</code> subdirectory. Alternatively you can 
use the <a href="http://github.com/mbraceproject/MBrace/raw/master/nuget/installer/Install-MBrace.ps1">Install-MBrace.ps1</a> powershell script that helps you install 
MBrace by downloading <code>.NET 4.5</code> if it's needed, downloading the
runtime nuget package, adding firewall exceptions for the MBrace executables and finally 
installing the MBrace runtime as a Windows Service.</p>

<p>Open a PowerShell prompt as administrator, download and run <code>Install-MBrace.ps1</code> script.
Before running the installation script you probably need to enable script execution in PowerShell;
you can do this using the <a href="http://technet.microsoft.com/en-us/library/ee176961.aspx">Set-ExecutionPolicy</a> cmdlet.</p>

<table class="pre"><tr><td><pre lang="batchfile">PS C:\mbrace &gt; help .\Install-MBrace.ps1

NAME
    C:\mbrace\Install-MBrace.ps1

SYNOPSIS
    Installation script for the MBrace runtime.

SYNTAX
    C:\mbrace\Install-MBrace.ps1 [-AddToPath] [-Service] [[-Directory] &lt;String&gt;] [&lt;CommonParameters&gt;]

PARAMETERS
    -AddToPath [&lt;SwitchParameter&gt;]
        Add the MBrace.Runtime/tools directory to PATH environment variable. This parameter defaults to false.

    -Service [&lt;SwitchParameter&gt;]
        Install MBrace Windows service. This parameter defaults to true.

    -Directory &lt;String&gt;
        Installation directory. This parameter defaults to the Program Files directory.

DESCRIPTION
    This script implements the following workflow:
        * Install .NET 4.5 if it&#39;s needed.
        * Download the NuGet standalone and the latest MBrace.Runtime package.
        * Add firewall exceptions for the mbraced and mbrace.worker executables.
        * Install and starts the MBrace Windows service.
    Note that administrator rights are required.


RELATED LINKS
    http://github.com/mbraceproject/MBrace
    http://nessos.github.io/MBrace
    http://www.m-brace.net/


PS C:\mbrace &gt; Set-ExecutionPolicy Unrestricted
PS C:\mbrace &gt; .\Install-MBrace.ps1
* Checking for admin permissions...
* Checking if .NET 4.5 installed...
* Downloading NuGet...
* Downloading MBrace.Runtime...
* Adding firewall rules...
* Installing MBrace service...
* Done...
</pre></td></tr></table>

<p>At this point you should have the <code>MBrace Runtime</code> service running. You can confirm this by using the <code>Get-Service</code> cmdlet or the Services tool.</p>

<table class="pre"><tr><td><pre lang="batchfile">c:\mbrace &gt; Get-Service MBrace

Status   Name               DisplayName
------   ----               -----------
Running  MBrace             MBrace Runtime
</pre></td></tr></table>

<h2><a name="a-name-configureservice-a-Configuring-MBrace" class="anchor" href="#a-name-configureservice-a-Configuring-MBrace"><a name="configureservice"></a>Configuring MBrace</a></h2>

<p>Now you need to make any configurations to the MBrace daemon by changing the <code>mbraced.exe.config</code> file.
Normally you don't need to change this file and you can skip this step.
Below you can see the options you can configure.</p>

<ul>
<li><code>hostname</code> This is the hostname used by the daemon and the MBrace API. It can be either the hostname of the host machine or
an IP address. You can also specify an IP range in CIDR format; in this case the hostname of the daemon will be
the address of the first interface that belongs to the given range. Leave this setting blank to use the machine's hostname.</li>
<li><code>primary port</code> The TCP port used by the daemon.</li>
<li><code>worker ports</code> Available port for use by mbrace workers.</li>
<li><code>worker port range</code> Available port range for use by mbrace workers.</li>
<li><code>permissions</code> Permitted operation modes for this node; None: 0, Slave: 1, Master: 2, All: 3.</li>
<li><code>working directory</code> Specifies the working directory. This is the place where assemblies and the cache will be stored.
Use <code>temp</code> for the system temp folder.</li>
<li><code>log file</code> Specifies a log file for the daemon. This can either be an absolute path or a relative path to the <code>working directory</code>.</li>
<li><code>log level</code> Specify logs verbosity. Use 2 to display only Errors, 1 to also display Warnings and 0 for full verbosity.</li>
<li><code>mbrace processdomain executable</code> Executable name for <code>mbrace.worker.exe</code>.</li>
</ul>

<p>You can see and example of the appSettings section of a <code>mbraced.exe.config</code> file.</p>

<table class="pre"><tr><td><pre lang="xml"><span class="k">&lt;</span><span class="i">appSettings</span><span class="k">&gt;</span>
    <span class="c">&lt;!-- hostname that uniquely and globally identifies the host machine of the daemon. This can be an IP address. --&gt;</span>
    <span class="k">&lt;</span><span class="i">add</span> <span class="o">key</span><span class="k">="hostname"</span> <span class="o">value</span><span class="k">="10.0.1.0/27"</span> <span class="k">/&gt;</span> 
    <span class="c">&lt;!-- Primary TCP port --&gt;</span>
    <span class="k">&lt;</span><span class="i">add</span> <span class="o">key</span><span class="k">="primary port"</span> <span class="o">value</span><span class="k">="2675"</span> <span class="k">/&gt;</span>
    <span class="c">&lt;!-- available ports for mbrace workers --&gt;</span>
    <span class="k">&lt;</span><span class="i">add</span> <span class="o">key</span><span class="k">="worker port range"</span> <span class="o">value</span><span class="k">="30000, 30020"</span> <span class="k">/&gt;</span>
    <span class="c">&lt;!-- permitted operation modes; None: 0, Slave: 1, Master: 2, All: 3 --&gt;</span>
    <span class="k">&lt;</span><span class="i">add</span> <span class="o">key</span><span class="k">="permissions"</span> <span class="o">value</span><span class="k">="3"</span> <span class="k">/&gt;</span>
    <span class="c">&lt;!-- the working directory of the node; paths relative to executable; use "temp" for system temp folder --&gt;</span>
    <span class="k">&lt;</span><span class="i">add</span> <span class="o">key</span><span class="k">="working directory"</span> <span class="o">value</span><span class="k">="temp"</span> <span class="k">/&gt;</span>
    <span class="c">&lt;!-- logfile; paths relative to declared working directory --&gt;</span>
    <span class="k">&lt;</span><span class="i">add</span> <span class="o">key</span><span class="k">="log file"</span> <span class="o">value</span><span class="k">="mbrace-log.txt"</span> <span class="k">/&gt;</span>
    <span class="c">&lt;!-- specify loglevel: info 0, warning 1, error 2--&gt;</span>
    <span class="k">&lt;</span><span class="i">add</span> <span class="o">key</span><span class="k">="log level"</span> <span class="o">value</span><span class="k">="0"</span> <span class="k">/&gt;</span>
    <span class="c">&lt;!-- executable name of mbrace child process --&gt;</span>
    <span class="k">&lt;</span><span class="i">add</span> <span class="o">key</span><span class="k">="mbrace processdomain executable"</span> <span class="o">value</span><span class="k">="mbrace.worker.exe"</span> <span class="k">/&gt;</span>
<span class="k">&lt;/</span><span class="i">appSettings</span><span class="k">&gt;</span>
</pre></td></tr></table>

<p>Finally you need to restart the service in order to load the new configuration.</p>

<table class="pre"><tr><td><pre lang="batchfile">c:\mbrace &gt; Restart-Service MBrace
</pre></td></tr></table>

<p>You can repeat this process to install MBrace on multiple machines.</p>

<h2><a name="a-name-bootruntime-a-Booting-the-MBrace-Runtime" class="anchor" href="#a-name-bootruntime-a-Booting-the-MBrace-Runtime"><a name="bootruntime"></a>Booting the MBrace Runtime</a></h2>

<p>At this point your machines are running and the MBrace nodes are idle.
At your client machine, you need to install the F# interactive (or optionally Visual Studio or any environment supporting F#)
as well as the <a href="http://www.nuget.org/packages/MBrace.Runtime">MBrace.Runtime</a> package from nuget.</p>

<p>In your solution open the <code>mbrace-tutorial.fsx</code>. In the <em>initialize a runtime of remote nodes</em> section
change the hostnames and ports. Depending on your configuration use either IP addresses</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 11)" onmouseover="showTip(event, 'fs4', 11)" class="i">nodes</span> <span class="o">=</span>
    [
        <span onmouseout="hideTip(event, 'fs4', 12)" onmouseover="showTip(event, 'fs4', 12)" class="i">MBraceNode</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 13)" onmouseover="showTip(event, 'fs4', 13)" class="i">Connect</span>(<span class="s">&quot;10.0.1.4&quot;</span>, <span class="n">2675</span>)
        <span onmouseout="hideTip(event, 'fs4', 14)" onmouseover="showTip(event, 'fs4', 14)" class="i">MBraceNode</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 15)" onmouseover="showTip(event, 'fs4', 15)" class="i">Connect</span>(<span class="s">&quot;10.0.1.5&quot;</span>, <span class="n">2675</span>)
        <span onmouseout="hideTip(event, 'fs4', 16)" onmouseover="showTip(event, 'fs4', 16)" class="i">MBraceNode</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 17)" onmouseover="showTip(event, 'fs4', 17)" class="i">Connect</span>(<span class="s">&quot;10.0.1.6&quot;</span>, <span class="n">2675</span>)
    ]
</pre>
</td>
</tr>
</table>

<p>or hostnames</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 18)" onmouseover="showTip(event, 'fs4', 18)" class="i">nodes</span> <span class="o">=</span> [<span class="n">1..</span><span class="n">3</span>] <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 19)" onmouseover="showTip(event, 'fs4', 19)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 20)" onmouseover="showTip(event, 'fs6', 20)" class="f">map</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs7', 21)" onmouseover="showTip(event, 'fs7', 21)" class="i">i</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs4', 22)" onmouseover="showTip(event, 'fs4', 22)" class="i">MBraceNode</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 23)" onmouseover="showTip(event, 'fs4', 23)" class="i">Connect</span>(<span onmouseout="hideTip(event, 'fs4', 24)" onmouseover="showTip(event, 'fs4', 24)" class="i">sprintf</span> <span class="s">&quot;machine%d&quot;</span> <span onmouseout="hideTip(event, 'fs4', 25)" onmouseover="showTip(event, 'fs4', 25)" class="i">i</span>, <span class="n">2675</span>))
</pre>
</td>
</tr>
</table>

<p>Now ping the nodes to ensure connectivity</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span onmouseout="hideTip(event, 'fs4', 26)" onmouseover="showTip(event, 'fs4', 26)" class="i">nodes</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 27)" onmouseover="showTip(event, 'fs4', 27)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 28)" onmouseover="showTip(event, 'fs8', 28)" class="f">iter</span> (<span class="k">fun</span> <span onmouseout="hideTip(event, 'fs9', 29)" onmouseover="showTip(event, 'fs9', 29)" class="i">n</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs4', 30)" onmouseover="showTip(event, 'fs4', 30)" class="f">printfn</span> <span class="s">&quot;Node </span><span class="pf">%A</span><span class="s"> : </span><span class="pf">%s</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs9', 31)" onmouseover="showTip(event, 'fs9', 31)" class="i">n</span> <span class="o">&lt;|</span> <span class="k">try</span> <span onmouseout="hideTip(event, 'fs9', 32)" onmouseover="showTip(event, 'fs9', 32)" class="i">n</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 33)" onmouseover="showTip(event, 'fs4', 33)" class="i">Ping</span>()<span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 34)" onmouseover="showTip(event, 'fs4', 34)" class="i">ToString</span>() <span class="k">with</span> _ <span class="k">-&gt;</span> <span class="s">&quot;failed&quot;</span>)
</pre>
</td>
</tr>
</table>

<p>At this point, before actually booting a runtime you need to configure which store
will be used by the runtime. By default each node will use its local filesystem, 
but in distributed scenarios you need to use storage common to all participating nodes like
the <em>Windows Azure Blob Storage</em>, <em>SQL Server</em>, or any implementation of the <code>ICloudStore</code> interface.
In this example we are going to use the <code>FileSystemStore</code> that comes with MBrace
with a UNC path that is accesible to all nodes. <em>Note:</em> The FileSystemStore should be used only for
testing purposes.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs4', 35)" onmouseover="showTip(event, 'fs4', 35)" class="i">Nessos</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 36)" onmouseover="showTip(event, 'fs4', 36)" class="i">MBrace</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 37)" onmouseover="showTip(event, 'fs4', 37)" class="i">Store</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 38)" onmouseover="showTip(event, 'fs4', 38)" class="i">fileSystemStore</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 39)" onmouseover="showTip(event, 'fs4', 39)" class="i">FileSystemStore</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 40)" onmouseover="showTip(event, 'fs4', 40)" class="i">Create</span> <span class="s">@&quot;\\shared\mbrace&quot;</span>

<span onmouseout="hideTip(event, 'fs4', 41)" onmouseover="showTip(event, 'fs4', 41)" class="i">MBraceSettings</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 42)" onmouseover="showTip(event, 'fs4', 42)" class="i">DefaultStore</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs4', 43)" onmouseover="showTip(event, 'fs4', 43)" class="i">fileSystemStore</span>
</pre>
</td>
</tr>
</table>

<p>Finally boot the runtime and send your first cloud computation.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 44)" onmouseover="showTip(event, 'fs4', 44)" class="i">runtime</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs4', 45)" onmouseover="showTip(event, 'fs4', 45)" class="i">MBrace</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 46)" onmouseover="showTip(event, 'fs4', 46)" class="i">Boot</span> <span onmouseout="hideTip(event, 'fs4', 47)" onmouseover="showTip(event, 'fs4', 47)" class="i">nodes</span>

<span onmouseout="hideTip(event, 'fs4', 48)" onmouseover="showTip(event, 'fs4', 48)" class="i">runtime</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 49)" onmouseover="showTip(event, 'fs4', 49)" class="i">Run</span> &lt;@ <span onmouseout="hideTip(event, 'fs4', 50)" onmouseover="showTip(event, 'fs4', 50)" class="i">cloud</span> { <span class="k">return</span> <span class="n">42</span> } @&gt;
</pre>
</td>
</tr>
</table>

<div class="tip" id="fs1">namespace MBrace</div>
<div class="tip" id="fs2">namespace MBrace.Azure</div>
<div class="tip" id="fs3">namespace MBrace.Azure.Client</div>
<div class="tip" id="fs4"></div>
<div class="tip" id="fs5">val defaultof&lt;&#39;T&gt; : &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.Unchecked.defaultof</div>
<div class="tip" id="fs6">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; list:&#39;T list -&gt; &#39;U list<br /><br />Full name: Microsoft.FSharp.Collections.List.map</div>
<div class="tip" id="fs7">val i : int</div>
<div class="tip" id="fs8">val iter : action:(&#39;T -&gt; unit) -&gt; list:&#39;T list -&gt; unit<br /><br />Full name: Microsoft.FSharp.Collections.List.iter</div>
<div class="tip" id="fs9">val n : obj</div>

        </div>
        <div class="span3">
          <a href="http://www.m-brace.net/index.html">
            <img src="http://www.m-brace.net/img/mbrace.png" alt="F# Project" style="width:150px;margin:10px" />
          </a>
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">MBrace</li>
            <li><a href="http://www.m-brace.net/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://www.nuget.org/packages/MBrace.Core">Get Library via NuGet</a></li>
            <li><a href="http://github.com/mbraceproject/MBrace.Core">Source Code on GitHub</a></li>
            <li><a href="http://github.com/mbraceproject/MBrace.Core/blob/master/LICENSE.md">License</a></li>
            <li><a href="http://github.com/mbraceproject/MBrace.Core/blob/master/RELEASE_NOTES.md">Release Notes</a></li>

            <li class="nav-header">Getting Started</li>
            <li><a href="http://www.m-brace.net/runtime-deployment.html">Cluster Deployment Guide</a></li>
            <li><a href="http://www.m-brace.net/azure-tutorial.html">Azure Guide</a></li>
            <li class="divider"></li>
            <li><a target="_blank" href="http://skillsmatter.com/skillscasts/5157-mbrace-large-scale-distributed-computation-with-f">Video presentation</a></li>
            <li><a target="_blank" href="http://www.m-brace.net/mbrace-plos.pdf">PLOS'13 Publication</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="http://www.m-brace.net/programming-model.html">Programming model</a></li>
            <li><a href="http://www.m-brace.net/client-api.html">Client API</a></li>
            <li><a target="_blank" href="http://www.m-brace.net/mbrace-manual.pdf">MBrace Manual</a></li>
            <li><a href="http://www.m-brace.net/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/mbraceproject/MBrace.Core"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
